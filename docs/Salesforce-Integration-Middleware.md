# Salesforce Integration Middleware #

## Objective

This solution aims to be used for different implementations with any client in a simple way, in which it is necessary to establish a live chat, through a Yalo bot and the Salesforce CRM platform.

## Chat creation flow

The flow implemented for creating chat between an end user and a human agent in Salesforce is as follows:

1. The user is interacting with a Yalo bot.
2. If the user requests human assistance by writing the keyword **"Ayuda"** and selecting the reason for the query, Yalo Core, puts the artificial intelligence in a waiting state and the Yalo Component creates a Chat session with Salesforce by making a request to the [v1/chats/connect](/docs/Salesforce-Integrations-Endpoints.md) endpoint of this solution.
3. The endpoint must consume the following minimum information to create a chat:

    ## Chat Request #
    
| Api name    | Description                                                                                                                                                                                                       |
|-------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| userID      | UserID of the user, the phone number of WhatsApp or the FacebookId of the Facebook bot.                                                                                                                           |
| botSlug     | Bot name.                                                                                                                                                                                                         |
| botId       | WhatsApp Bot Phone or Facebook Bot Page ID.                                                                                                                                                                       |
| name        | User name.                                                                                                                                                                                                        |
| provider    | whatsApp or facebook message provider.                                                                                                                                                                            |
| email       | User email.                                                                                                                                                                                                       |
| phoneNumber | User's phone number, only allowed on WhatsApp                                                                                                                                                                     |
| extraData   | Mainly it is a map with the custom fields that the customer has in Salesforce to add to the cases and they are sent if we have the information. If necessary, you can submit metadata for custom implementations. |

4. First, it is validated that the user does not have a live chat in existence at the time of making the request.
5. Next, the international prefix is eliminated from the telephone number, these are configurable in to send ***SFC_CODE_PHONE_REMOVE***, by default it eliminates those of Mexico ***52*** and ***521***.
6. We search through the email or phone received that there is a **contact** or **personal account** in the customer's Salesforce account, if it does not exist, the contact or personal account is created.
7. We validate that the user is not blocked in Salesforce, if so, the corresponding chat is not created and through the **botrunner client** the user is changed to a **blocked user state**, specified in the **BLOCKED_USER_STATE** environment variable.
8. Once the contact has been validated in Salesforce, we create a query case with the data provided to add it and request a chat. [**ChatRequest in LiveAgent API**](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ChasitorInit.htm)
9. After successfully requesting the chat session with Salesforce, we save the information necessary to maintain the session in an **Interconnection** object in Redis.
10. Finally, we initialize in the **Interconnection** a goroutine that starts the ***[Long Polling](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_http_long_polling_loop.htm)***  process with Salesforce, with which we consume a service to identify the different events that happen in the chat every 5 seconds.
11. According to the events received, **salesforce-integration** performs the following actions:
    - ***204 HTTP Status :*** It means that there are no changes in the chat.
    - ***503 HTTP Status :*** An attempt will be made to reconnect the session because the connection to Salesforce was lost. More details [ReconnectSession](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ReconnectSession.htm)
    - **Other *Status HTTP :*** The **Interconnection** is ended and through the **Botrunner client** the user is changed to a **time-ended state**, specified in the environment variable **TIMEOUT_STATE.**
    - ***ChatRequestFail:*** The chat was not created correctly in the Salesforce console, due to no agents available in the queue the chat was sent to or some unknown error.
    - ***ChatRequestSuccess :*** The chat was created successfully, and the **Interconnection** goes to **OnHold** status waiting for a human agent to accept the chat.
        
        The service sends the user an "**Esperando agente**" message through the **Integrations API**.


    - ***ChatEstablished :*** An agent accepts the chat and the **Interconnection** goes to **Active status**, at this time both can send messages to each other, but before that, the service sends the context of the query as the first message, that is, the previous conversation between the bot's AI and the user before requesting a live chat.
    - ***ChatMessage :*** The agent sent a message to the user, then through **Integrations API**  we forward the message to the user to their **WhatsApp** or **Messenger**.
    - ***ChatEnded :*** The agent ended the chat and the **Interconnection** goes to **Closed** status, closing the session in the integration and through the **Botrunner client** the user is changed to a *successfully finished chat state*, specified in the environment variable **SUCCESS_STATE**.
    
    **How do I send a user's response to an agent in the Salesforce console?**
    
    When the instance is raised, we need to register the webhooks through the endpoint `/v1/integrations/webhook/register/{{provider}}`, then the webhooks are registered in the  **Integrations API**  that will receive the messages between the users and the bot. (One for WhatsApp and one for Facebook).
        
    If we receive a text or image message from a user, we validate the following: 
    
    - If the user does not have an **Active** or **OnHold** chat, this message is saved as context in Redis.
    - If there is an Active chat then through our [LiveAgent API](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ChatMessage_request.htm) client we send that message to the agent's console.
        
        If the message is of type image, a message is sent to the agent that says ""**El usuario adjunto una imagen al caso"**", and the image through our Salesforce API client is attached to the case.
        
    
    Any other type of message other than TEXT or IMAGE in the webhooks is ignored.

## Integrations API

  The **Integrations API** allows customers to send messages to their channel users. This component exposes a REST API. We receive requests for messages, with a payload similar to the one required by WhatsApp, and then send it to the customer's deployments.

## Endpoints

[Salesforce Integrations Endpoints](/docs/Salesforce-Integrations-Endpoints.md)

## DEMO

Below we share some videos in loom that show the operation of live chats through **salesforce-integration**.

- Whatsapp Bot and Salesforce:
[https://www.loom.com/share/87104e02df9a4994a5397a1dca7e47df](https://www.loom.com/share/87104e02df9a4994a5397a1dca7e47df) 
[https://loom.com/share/58ed8218edda419d88b65a017ebb8d58](https://loom.com/share/58ed8218edda419d88b65a017ebb8d58)
- Messenger Bot and Salesforce:
[https://www.loom.com/share/f9846243159043ba88021e3b11ca47da](https://www.loom.com/share/f9846243159043ba88021e3b11ca47da)

## salesforce-integration deploy

### Requirements

- Yalo
    - Whatsapp bot:
        - Have a line available.
        - Register bot in **integrations-admin**, thus obtaining the required jwt, to append it to the integration service.
        - Create a webhook or lambda with Yalo Studio to make a request with the integration, the request will be to the endpoint ***[/v1/chats/connect](/docs/Salesforce-Integrations-Endpoints.md)***
    - Facebook
        - Have a line available.
        - Register bot in **integrations-admin**, thus obtaining the required jwt, to append it to the integration service.
        - Create a webhook or lambda with Yalo Studio to make a request with the integration, the request will be to the endpoint ***[/v1/chats/connect](/docs/Salesforce-Integrations-Endpoints.md)***
    

    **Note:** It is not necessary to have both bots (WhatsApp and Facebook), to be able to send the chats at least it is necessary to have one bot. To test the endpoint ***/chats/connect*** locally it is not necessary.
    
- Customer
    
    Have a Salesforce account, provide some identifiers and permissions to be able to send chats to the Salesforce console, the minimum identifiers are described below
    
    ### Identifiers ###

| Name                               | Description                                                                                                                                                                                                                                                                                                                                                              | Required |
|------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| login_url                          | Authorization API URL to get the access token.                                                                                                                                                                                                                                                                                                                           | Yes      |
| base_url                           | API URL to be able to create contacts, cases and image upload.                                                                                                                                                                                                                                                                                                           | Yes      |
| live_agent_api_url                 | Agent Live API URL to request chats.                                                                                                                                                                                                                                                                                                                                     | Yes      |
| client_id                          | client_id to request an access token from the corresponding environment.                                                                                                                                                                                                                                                                                                 | Yes      |
| client_secret                      | client_secret to request an access token from the corresponding environment.                                                                                                                                                                                                                                                                                             | Yes      |
| username                           | username of the user-api to request an access token from the corresponding environment.                                                                                                                                                                                                                                                                                  | Yes      |
| password                           | password of the user-api to request an access token from the corresponding environment.                                                                                                                                                                                                                                                                                  | Yes      |
| security token                     | sfdsfUser-api security token                                                                                                                                                                                                                                                                                                                                             | No       |
| organizationId                     | Id of the organization required to create chats, it can be obtained in the console in section SERVICE SETUP→ADMINISTRATION→Channels→Chat-Deployments                                                                                                                                                                                                                     | Yes      |
| deploymentId                       | ID of the deployment required to create chats, it can be obtained in the console in section SERVICE SETUP→ADMINISTRATION→Channels→Chat-Deployments.                                                                                                                                                                                                                      | Yes      |
| recordTypeId                       | Necessary identifier in the request to create cases and identify queries, this data is only necessary if provided and requested by the client.                                                                                                                                                                                                                           | No       |
| accountRecordTypeId                | RecordTypeId required in requests to create personal accounts, it is only necessary if the client requires creating personal accounts instead of contacts.                                                                                                                                                                                                               | No       |
| buttonId                           | At least one buttonId is required, necessary in the chat request, send the chat to the queue assigned to this button. They can be viewed and configured in the section SERVICE SETUP→ADMINISTRATION→Channels→Chat→ Buttons&Invitations. The number of queues and buttons depends on the client. For more information see Salesforce-Integration - Buttons and Owners IDs | Yes      |
| OwnerId                            | OwnerId identifier used when creating the case, it is to identify which queue the chat was sent to, it is only necessary if the client requests it. The number of queues and buttons depends on the client. For more information, see Salesforce-Integration - Buttons and Owners IDs                                                                                    | No       |
| username (Salesforce Console User) | User to be able to use the console as an agent. It is required to simulate how agents receive the chats created by this Integration service. You need to be added to the queues where chat will be sent. If not, the chats created will never appear, request it with the Salesforce team or client.                                                                     | No       |
| password (Salesforce Console User) | User password to use the console as an agent.                                                                                                                                                                                                                                                                                                                            | No       |


### Environment variables to raise the instance

The environment variables to run this service are listed below:

| Name                                                  | Description                                                                                                                                                                                                                                                                                                                                                                           | Required |
|-------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| SALESFORCE-INTEGRATION_APP_NAME                       | The name that is displayed in the application. By default, it is salesforce-integration.                                                                                                                                                                                                                                                                                              | Yes      |
| SALESFORCE-INTEGRATION_HOST                           | The host for the API service.                                                                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_PORT                           | The port for the API service.                                                                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_ENVIRONMENT                    | The environment used for Sentry events or also for some functions that are required by the development or production environment. By default, it is **dev**.                                                                                                                                                                                                                          | No       |
| SALESFORCE-INTEGRATION_REDIS_MASTER                   | The name of the master in a Redis Sentinel instance.                                                                                                                                                                                                                                                                                                                                  | Yes      |
| SALESFORCE-INTEGRATION_REDIS_SENTINEL_ADDRESS         | The address of the Redis Sentinel instance.                                                                                                                                                                                                                                                                                                                                           | Yes      |
| SALESFORCE-INTEGRATION_BOTRUNNER_URL                  | URL of the "sent-to" API, used to change the state of a user in the bot flow.                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_BOTRUNNER_TIMEOUT              | Number of seconds to wait to send a request to the "sent-to" API.                                                                                                                                                                                                                                                                                                                     | No       |
| SALESFORCE-INTEGRATION_BLOCKED_USER_STATE             | Bot flow status to send to a user when blocked by Salesforce.                                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_TIMEOUT_STATE                  | Status of the flow of the Bot to send to a user when the chat is rejected because there are no active agents, because the waiting time for an agent to accept the chat has ended or due to an error that occurred in the Long-Polling.                                                                                                                                                | Yes      |
| SALESFORCE-INTEGRATION_SUCCESS_STATE                  | Bot flow status to send to a user when the chat ended successfully by the Salesforce agent.                                                                                                                                                                                                                                                                                           | Yes      |
| SALESFORCE-INTEGRATION_YALO_USERNAME                  | Username required to request a JWT and to be able to make requests to this integration service. We must use the /authenticate endpoint to request it.                                                                                                                                                                                                                                 | Yes      |
| SALESFORCE-INTEGRATION_YALO_PASSWORD                  | Password of the user required to request a JWT and to be able to make requests to this integration service. We must use the /authenticate endpoint to request it.                                                                                                                                                                                                                     | Yes      |
| SALESFORCE-INTEGRATION_SECRET_KEY                     | Secret key required to sign a JWT and be able to make requests to this integration service.                                                                                                                                                                                                                                                                                           | Yes      |
| SALESFORCE-INTEGRATION_SFC_CLIENT_ID                  | Value of the client_id, to request an access token from the Salesforce authorization API.                                                                                                                                                                                                                                                                                             | Yes      |
| SALESFORCE-INTEGRATION_SFC_CLIENT_SECRET              | Value of the client_secret, to request an access token from the Salesforce authorization API.                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_SFC_USERNAME                   | username of the user api, to request an access token from the Salesforce authorization API.                                                                                                                                                                                                                                                                                           | Yes      |
| SALESFORCE-INTEGRATION_SFC_PASSWORD                   | password of the user api, to request an access token to the Salesforce authorization API.                                                                                                                                                                                                                                                                                             | Yes      |
| SALESFORCE-INTEGRATION_SFC_SECURITY_TOKEN             | security token from the user api, to request an access token from the Salesforce authorization API. This value can be obtained in the Salesforce console in the section profile → configuration → Reset security token.                                                                                                                                                               | No       |
| SALESFORCE-INTEGRATION_SFC_BASE_URL                   | Base URL value to connect to the Salesforce API in order to create contacts, cases, and image uploads.                                                                                                                                                                                                                                                                                | Yes      |
| SALESFORCE-INTEGRATION_SFC_CHAT_URL                   | Base URL value to connect to Agent Live API to request chats.                                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_SFC_LOGIN_URL                  | Value of the base URL to connect to the Salesforce Authorization API.                                                                                                                                                                                                                                                                                                                 | Yes      |
| SALESFORCE-INTEGRATION_SFC_API_VERSION                | The version of the Salesforce APIs for the requests, preferably we should use the most current one. It is currently version 52.                                                                                                                                                                                                                                                       | Yes      |
| SALESFORCE-INTEGRATION_SFC_ORGANIZATION_ID            | organization_id identifier for chat requests.                                                                                                                                                                                                                                                                                                                                         | Yes      |
| SALESFORCE-INTEGRATION_SFC_ DEPLOYMENT_ID             | deployment_id identifier for chat requests.                                                                                                                                                                                                                                                                                                                                           | Yes      |
| SALESFORCE-INTEGRATION_SFC_RECORD_TYPE_ID             | record_type_id identifier to create the cases, this value is optional if the client has or Salesforce creates this value to identify these chats, it is not required, if this envar is not sent, it is omitted in the request to create cases.                                                                                                                                        | No       |
| SALESFORCE-INTEGRATION_SFC_ACCOUNT_RECORD_TYPE_ID     | Identifier of account_record_type_id to create personal accounts, this value is optional if the customer has or Salesforce creates this value to create personal accounts instead of a normal contact, it is not required, if this envar is not sent, the request to create a person_account and a request is sent to create a contact.                                               | No       |
| SALESFORCE-INTEGRATION_SFC_DEFAULT_BIRTH_DATE_ACCOUNT | Indicates the default date to create personal accounts in salesforce, only if the send ACCOUNT_RECORD_TYPE exists, in case the client requests a special date we can change it, by default it is "1921-01-01T00: 00: 00"                                                                                                                                                              | Yes      |
| SALESFORCE-INTEGRATION_SFC_CODE_PHONE_REMOVE          | Indicates the codes of the phones to be deleted if the phone number is greater than 10 digits. By default, the 521 and 52 corresponding to Mexico are eliminated, more codes can be added to this shipment, example: "521,52,54,57,1"                                                                                                                                                 | No       |
| SALESFORCE-INTEGRATION_SFC_SOURCE_FLOW_BOT            | It is a custom map to configure based on the client's need, from its value sent in the extraData of the field with key source_flow_bot, it helps us to obtain the value of the subject of the case, the buttonId and the ownerId of the queue to the that will be addressed in the chat and the case in Salesforce. We can see some examples in the following documentation here.     | No       |
| SALESFORCE-INTEGRATION_SFC_SOURCE_FLOW_FIELD          | Name of the field that we will use to identify the reason for the chat query, which must be sent in the extraData to obtain the subject of the case, the buttonId and the ownerId to which the chat and the case will be directed. By default, it is source_flow_bot.                                                                                                                 | Yes      |
| SALESFORCE-INTEGRATION_SFC_CUSTOM_FIELDS_CASE         | It contains a map with values of the customer's custom fields to create a case in your Salesforce platform, you can see an example here.                                                                                                                                                                                                                                              | No       |
| SALESFORCE-INTEGRATION_INTEGRATIONS_BASE_URL          | Base URL of the Integrations API for making requests.                                                                                                                                                                                                                                                                                                                                 | Yes      |
| SALESFORCE-INTEGRATION_WEBHOOK_BASE_URL               | Base URL of our webhooks, which will be registered in integrations-api, in which integrations-channels will send us the messages that the bot receives.                                                                                                                                                                                                                               | Yes      |
| SALESFORCE-INTEGRATION_INTEGRATIONS_WA_BOT_ID         | WhatsApp bot name.                                                                                                                                                                                                                                                                                                                                                                    | No       |
| SALESFORCE-INTEGRATION_INTEGRATiONS_WA_CHANNEL        | Channel used by WhatsApp bot.                                                                                                                                                                                                                                                                                                                                                         | No       |
| SALESFORCE-INTEGRATION_INTEGRATiONS_WA_BOT_JWT        | JWT from the WhatsApp bot.                                                                                                                                                                                                                                                                                                                                                            | No       |
| SALESFORCE-INTEGRATION_INTEGRATIONS_WA_BOT_PHONE      | Bot's phone with the prefix +52.                                                                                                                                                                                                                                                                                                                                                      | No       |
| SALESFORCE-INTEGRATION_INTEGRATiONS_FB_BOT_ID         | Name of the Facebook bot.                                                                                                                                                                                                                                                                                                                                                             | No       |
| SALESFORCE-INTEGRATION_INTEGRATiONS_FB_CHANNEL        | Channel used by the Facebook bot.                                                                                                                                                                                                                                                                                                                                                     | No       |
| SALESFORCE-INTEGRATION_INTEGRATiONS_FB_BOT_JWT        | JWT from the Facebook bot.                                                                                                                                                                                                                                                                                                                                                            | No       |
| SALESFORCE-INTEGRATION_INTEGRATIONS_FB_BOT_PHONE      | In the case of the Facebook bot, it is the Facebook pageID.                                                                                                                                                                                                                                                                                                                           | No       |
| SALESFORCE-INTEGRATION_KEYWORDS_RESTART               | Reserved words of the bot to restart the flow, in case these words are received in the webhook, the integration if it detects that there is an active chat with the user that the keyword reached, this will close the chat on the Salesforce side, this function it is only active in the development environment. By default, are the words: "coppelbot,regresar,reiniciar,restart" | No       |
| SALESFORCE-INTEGRATION_SFC_BLOCKED_CHAT_FIELD         | This variable is a boolean that activates the blocking of a contact, for this it is required to ask saleforce to append the CP_BlockedChatYalo__c field to the customer's contacts, so that the integration validates this field, if it is true it is sent to the state specified in the envar BLOCKED_USER_STATE. By default it is false.                                            | No       |
| SALESFORCE-INTEGRATION_SPEC_SHEDULE                   | It tells us every few minutes we are going to launch a request to SalerforceAPI, to prevent the token from expiring due to inactivity by the integration user, by default it is every 59 min.                                                                                                                                                                                         | No       |


## Salesforce endpoints

The Salesforce endpoints used by this integration are listed below:

| Service                             | Endpoint                                                                                                                                                        | Documentation                                                                                                                                                                                                                                                                                                                                                                |
|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Search contact by email             | /services/data/v52.0/query/?q=SELECT+id+,+firstName+,+lastName+,+mobilePhone+,+email+,+CP_BlockedChatYalo__c+FROM+Contact+WHERE+email+=+%27ochoa@example.com%27 | This query must be adjusted for every customer. See below for guidance. The resulting query must return one or no rows having an email as parameter                                                                                                                                                                                                                          |
| Search contact by mobile phone      | /services/data/v52.0/query/?q=SELECT+id+,+firstName+,+lastName+,+mobilePhone+,+email+,+CP_BlockedChatYalo__c+FROM+Contact+WHERE+mobilePhone+=+%277331175588%27  | This query must be adjusted for every customer. See below for guidance. The resulting query must return one or no rows having a phone number as parameter                                                                                                                                                                                                                    |
| Create personal account             | /services/data/v52.0/sobjects/Account                                                                                                                           | https://developer.salesforce.com/docs/atlas.en-us.object_reference.meta/object_reference/sforce_api_objects_account.htm                                                                                                                                                                                                                                                      |
| Create contact                      | /services/data/v52.0/sobjects/Contact                                                                                                                           | https://developer.salesforce.com/docs/atlas.en-us.object_reference.meta/object_reference/sforce_api_objects_contact.htm                                                                                                                                                                                                                                                      |
| Search personal account             | /services/data/v52.0/query/?q=SELECT+id+,+firstName+,+lastName+,+PersonMobilePhone+,+PersonEmail+,+PersonContactId+FROM+Account+WHERE+id+=+'124554'             | This query must be adjusted for every customer. See below for guidance. The resulting query must return one and only one row because it uses a SF id as parameter.                                                                                                                                                                                                           |
| Create Case                         | /services/data/v52.0/sobjects/Case                                                                                                                              | https://developer.salesforce.com/docs/atlas.en-us.object_reference.meta/object_reference/sforce_api_objects_case.htm                                                                                                                                                                                                                                                         |
| Get chat session                    | /chat/rest/System/SessionId                                                                                                                                     | https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_SessionId.htm                                                                                                                                                                                                                                                         |
| Create chat                         | /chat/rest/Chasitor/ChasitorInit                                                                                                                                | https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ChasitorInit.htm                                                                                                                                                                                                                                                      |
| Get messages (Long Polling)         | /chat/rest/System/Messages                                                                                                                                      | https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_Messages.htm                                                                                                                                                                                                                                                          |
| Send Message                        | /chat/rest/Chasitor/ChatMessage                                                                                                                                 | https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ChatMessage_request.htm                                                                                                                                                                                                                                               |
| Create ContentVersion (Upload file) | /services/data/v52.0/sobjects/ContentVersion                                                                                                                    | https://www.appseconnect.com/how-to-upload-a-document-in-salesforce-files-using-rest-api/  https://developer.salesforce.com/docs/atlas.en-us.object_reference.meta/object_reference/sforce_api_objects_contentversion.htm                                                                                                                                                    |
| Search DocumentViewId               | /services/data/v52.0/query/?q=SELECT+ContentDocumentID+FROM+ContentVersion+WHERE+id+=+'{{contenVersionID}}'                                                     |                                                                                                                                                                                                                                                                                                                                                                              |
| Link image to a case                | /services/data/v52.0/sobjects/ContentDocumentLink                                                                                                               | https://www.appseconnect.com/how-to-upload-a-document-in-salesforce-files-using-rest-api/                                                                                                                                                                                                                                                                                    |
| Reconnect                           | /chat/rest/System/ReconnectSession?ReconnectSession.offset={{offset}}                                                                                           | https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_ReconnectSession.htm                                                                                                                                                                                                                                                  |
| Get access token                    | /services/oauth2/token                                                                                                                                          | http://bestirtech.com/blog/2021/03/calling-salesforce-custom-rest-api-postman-example/ **Note:** In this integration we realized that the token requested by default password expires every 2 hrs due to inactivity, therefore a request was implemented every 59 min.  https://help.salesforce.com/s/articleView?id=sf.remoteaccess_oauth_username_password_flow.htm&type=5 |
| Composite                           | /services/data/v52.0/ composite                                                                                                                                 | https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/resources_composite_composite.htm                                                                                                                                                                                                                                                                   |


<aside>
💡 The endpoints that issue a query against Salesforce must be adjusted and validated with every customer, since it is likely that each of them have custom fields in place that must be considered to get the desired result/validation in the integration.
The easiest way to refine and test the query is using the Salesforce Developer Console. This is a web tool available from the main SF interface where you can issue SOQL queries. Please consider that for a validated query to work with the integration, the integration user created for Yalo must have read access to all the fields and objects in each query.

***Accessing the Developer Console from SF Main UI***

![Untitled](/docs/images/sf-console.png)

All endpoints are URL encoded, so to validate and tweak them you will have to decode them first. For this you can use your favorite online url encoding/decoding site (or the one that Google kindly suggest you).

Once decoded, the endpoint string will look like this:

/services/data/v52.0/query/?q=**SELECT id , firstName , lastName , mobilePhone , email , CP_BlockedChatYalo__c FROM Contact WHERE email = 'ochoa@example.com'** 

In order to test it you will have to copy the text in **bold** and paste it the SF Developer Console.

***Testing the default query to search a client from an email***

![Untitled](/docs/images/query-editor.png)

In this example, the default query doesn't work because this SF instance doesn't have a field called "CP_BlockedChatYalo__c". 

Once you have modified the query according to the customer needs, you will need to re-encode the endpoint. In this case, it would look like this:

**/services/data/v52.0/query/?q=SELECT+id%2C+firstName%2C+lastName%2C+mobilePhone%2C+email+FROM+Contact+WHERE+email+%3D+%27ochoa%[40example.com](http://40example.com/)%27**

You must inform the operations team that assist you installing your instance of the integration of your new set of endpoints so as they can put them in place.

</aside>

## References:

- [RFC 155 - Salesforce integration](/docs/RFC-155.md).
- [Live Agent API Rest.](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_API_endpoint.htm)
- [Long Polling in Salesforce.](https://developer.salesforce.com/docs/atlas.en-us.live_agent_rest.meta/live_agent_rest/live_agent_rest_http_long_polling_loop.htm)

[Salesforce-Integration - Buttons and Owners IDs](/docs/Salesforce-Integration-Buttons-and-Owners-IDs.md)

[Envar SfcSourceFlowBot](/docs/SfcSourceFlowBot-env-var.md)

[Interconnection ](/docs/Interconnection.md)

[Facebook Message - Integration](https://developers.facebook.com/docs/messenger-platform/webhooks)
